/************************
this file helps clean up indexes in QREST
**************************/

SELECT S.name as 'Schema',
T.name as 'Table',
I.name as 'Index',
DDIPS.avg_fragmentation_in_percent,
DDIPS.page_count
FROM sys.dm_db_index_physical_stats (DB_ID(), NULL, NULL, NULL, NULL) AS DDIPS
INNER JOIN sys.tables T on T.object_id = DDIPS.object_id
INNER JOIN sys.schemas S on T.schema_id = S.schema_id
INNER JOIN sys.indexes I ON I.object_id = DDIPS.object_id
AND DDIPS.index_id = I.index_id
WHERE DDIPS.database_id = DB_ID()
and I.name is not null
AND DDIPS.avg_fragmentation_in_percent >1
ORDER BY DDIPS.avg_fragmentation_in_percent desc


ALTER INDEX PK_T_QREST_REF_PAR_METHODS ON T_QREST_REF_PAR_METHODS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_REF_PARAMETERS ON T_QREST_REF_PARAMETERS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_REF_QUALIFIER ON T_QREST_REF_QUALIFIER REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_REF_AQS_AGENCY ON T_QREST_REF_AQS_AGENCY REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_USER_NOTIFICATION ON T_QREST_USER_NOTIFICATION REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_DATA_IMPORTS ON T_QREST_DATA_IMPORTS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_SITES ON T_QREST_SITES REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_HELP_DOCS ON T_QREST_HELP_DOCS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_AQS ON T_QREST_AQS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_QREST_DATA_IMPORT_TEMP ON T_QREST_DATA_IMPORT_TEMP REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_USERS ON T_QREST_USERS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_MONITORS ON T_QREST_MONITORS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_ASSESS_DOCS ON T_QREST_ASSESS_DOCS REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_SITE_POLL_CONFIG ON T_QREST_SITE_POLL_CONFIG REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_SITE_POLL_CONFIG_DTL ON T_QREST_SITE_POLL_CONFIG_DTL REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_SYS_LOG ON T_QREST_SYS_LOG REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_QC_ASSESSMENT ON T_QREST_QC_ASSESSMENT REBUILD WITH (ONLINE = OFF);
ALTER INDEX PK_T_QREST_QC_ASSESSMENT_DTL ON T_QREST_QC_ASSESSMENT_DTL REBUILD WITH (ONLINE = OFF);

ALTER INDEX PK_T_QREST_SYS_LOG_ACTIVITY ON T_QREST_SYS_LOG_ACTIVITY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);

ALTER INDEX PK_T_QREST_DATA_HOURLY ON T_QREST_DATA_HOURLY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX nci_wi_T_QREST_DATA_HOURLY_2 ON T_QREST_DATA_HOURLY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX nci_wi_T_QREST_DATA_HOURLY_3 ON T_QREST_DATA_HOURLY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX nci_wi_T_QREST_DATA_HOURLY_4 ON T_QREST_DATA_HOURLY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX nci_wi_T_QREST_DATA_HOURLY_91F5B70275EB4F960DD03317940F4B0E ON T_QREST_DATA_HOURLY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX nci_wi_T_QREST_DATA_HOURLY_127D1F43E20002699B3BBD446C9FFD99 ON T_QREST_DATA_HOURLY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX nci_msft_1_T_QREST_DATA_HOURLY_71EA3E57D1A206D429FD8BB9D00F5F87 ON T_QREST_DATA_HOURLY REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);

ALTER INDEX PK_T_QREST_DATA_HOURLY_LOG ON T_QREST_DATA_HOURLY_LOG REBUILD WITH  (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX nci_msft_1_T_QREST_DATA_HOURLY_LOG_DECCB2C27BF88FE297EE8C22AB2167CF ON T_QREST_DATA_HOURLY_LOG REBUILD WITH  (ONLINE = ON, FILLFACTOR = 90);

ALTER INDEX PK_T_QREST_DATA_FIVE_MIN ON T_QREST_DATA_FIVE_MIN REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);
ALTER INDEX IDX_FIVE_MIN_3 ON T_QREST_DATA_FIVE_MIN REBUILD WITH (ONLINE = ON, FILLFACTOR = 90);